{% load humanize %}

<form action="{% url 'cartadd' product.id %}" method="POST">
  {% csrf_token %}
  <article
    class="bg-[#0b0b0b] border border-gray-800 rounded-2xl overflow-hidden shadow-sm h-full"
  >
    <div
      class="relative aspect-[1/1] rounded-t-xl overflow-hidden bg-center bg-cover"
      style="background-image: url('{{ product.product_image.url }}');"
    >
      <button
        type="button"
        class="play-btn absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-14 h-14 rounded-full bg-gradient-to-tr from-purple-500 to-pink-400 flex items-center justify-center ring-4 ring-black/40 shadow-lg hover:scale-105 transition"
        data-product-id="{{ product.id }}"
        aria-label="Play preview for {{ product.title }}"
      >
        <svg
          class="play-icon w-6 h-6 text-white"
          viewBox="0 0 24 24"
          fill="none"
        >
          <path d="M8 5v14l11-7L8 5z" fill="currentColor" />
        </svg>
        <!-- you may add a pause icon element and toggle display -->
      </button>
    </div>

    {% if product.preview_file %}
    <audio
      id="audio-{{ product.id }}"
      preload="none"
      src="{{ product.preview_file.url }}"
    ></audio>
    {%else%}
    <audio
      id="audio-{{ product.id }}"
      preload="none"
      src="{{ product.file.url }}"
    ></audio>
    {% endif %}

    <!-- optional: small progress bar -->
    <div class="p-5 space-y-3">
      <!-- ... other card content ... -->
      {% if product.preview_file or product.file %}
      <div class="mt-3">
        <div class="w-full bg-gray-700 rounded h-1 overflow-hidden">
          <div
            id="progress-{{ product.id }}"
            class="h-1 bg-purple-400"
            style="width: 0%"
          ></div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <div class="p-5 space-y-3">
      <h3 class="text-white font-semibold">{{ product.title }}</h3>
      <p class="text-sm text-gray-400">
        by
        <a href="{%url 'profile' id=product.seller.id %}" class="text-gray-200"
          >{% if product.seller.artist_name %} {{ product.seller.artist_name }}
          {% else %} {{ product.seller.username }} {% endif %}</a
        >
      </p>
      <a href="{%url 'productdetail' product.id %}" class="inline-flex items-center gap-2 bg-gradient-to-tr from-blue-500 to-yellow-200 text-black px-4 py-2 text-sm rounded-lg shadow hover:scale-[1.02] transition"
          >View</a
          >
      
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-2">
          <span
            class="text-xs bg-indigo-900 text-indigo-300 px-3 py-1 rounded-full"
            >{{ product.genre.name|default:"-" }}</span
          >
          <span class="text-xs text-gray-400"
            >{{ product.created_at|date:"M d, Y" }}</span
          >
        </div>
        <div class="text-sm text-gray-400 flex items-center gap-2">
          <span class="flex items-center gap-1">
            <svg
              class="w-4 h-4 text-yellow-400"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.789 1.402 8.168L12 18.896 4.664 23.167l1.402-8.168L.132 9.21l8.2-1.192z"
              />
            </svg>
            <span class="text-white font-semibold text-sm"
              >{{ product.avg_rating|default:0|floatformat:1 }}</span
            >
          </span>
          <span class="text-xs text-gray-500"
            >{{ product.downloads|default:0 }} sales</span
          >
        </div>
      </div>

      <div class="flex items-center justify-between mt-4">
        <div>
          <div class="text-xl font-bold text-white">${{ product.price|intcomma }}</div>
        </div>
        <div class="flex items-center gap-3">
          
          {% if product.seller == request.user %}
          <a
          href="{%url 'edit-product' id=product.id%}"
            class="inline-flex items-center gap-2 bg-gradient-to-tr from-yellow-500 to-yellow-200 text-black px-4 py-2 text-sm rounded-lg shadow hover:scale-[1.02] transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-pencil"
              viewBox="0 0 16 16"
            >
              <path
                d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"
              />
            </svg>
            Edit
          </a>
          {% else %}
          <button
            class="inline-flex items-center gap-2 bg-gradient-to-tr from-purple-500 to-pink-400 text-white px-4 py-2 text-sm rounded-lg shadow hover:scale-[1.02] transition"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart3" viewBox="0 0 16 16">
            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .49.598l-1 5a.5.5 0 0 1-.465.401l-9.397.472L4.415 11H13a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l.84 4.479 9.144-.459L13.89 4zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
          </svg>
            Add to Cart
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </article>
</form>
